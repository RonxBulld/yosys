# Yosys测试脚本：验证VBUF连接关系的select指令
# 

# 读取Verilog文件
read_verilog vbuf_test.v

# 进入测试模块
cd test_vbuf_connections

# 显示所有VBUF器件
echo "所有VBUF器件："
select t:VBUF
ls

# 清除选择
select -clear

echo "=============================================="
echo "查找输入端口I直接连接到其他VBUF输出端口O的VBUF器件："
echo ""

# 方法1：基本方法
echo "方法1 - 基本扩展选择："
select t:VBUF %x1:+[O] w:* %x1:+[I],VBUF t:VBUF %i
ls
echo "选中的器件数量："
select -count

echo ""
echo "=============================================="

# 清除选择
select -clear

# 方法2：更详细的分步方法
echo "方法2 - 分步分析："

# 步骤1：保存所有VBUF
select -set all_vbuf t:VBUF
echo "步骤1 - 所有VBUF器件："
select @all_vbuf
ls

# 步骤2：找到所有VBUF的输出线网
select @all_vbuf %x1:+[O] w:* %i
select -set vbuf_output_nets %
echo "步骤2 - VBUF输出连接的线网："
select @vbuf_output_nets
ls

# 步骤3：找到连接到这些线网的VBUF输入端口
select @vbuf_output_nets %x1:+[I],VBUF t:VBUF %i
echo "步骤3 - 最终结果（输入端口I连接到其他VBUF输出的VBUF器件）："
ls
echo "选中的器件数量："
select -count

echo ""
echo "=============================================="

# 验证结果：应该选中vbuf2, vbuf3, vbuf4
# vbuf1不应该被选中（它的输入没有连接到其他VBUF的输出）
# vbuf5不应该被选中（它的输出没有连接到其他VBUF的输入）
# vbuf6不应该被选中（它的输入没有连接到其他VBUF的输出）

echo "验证：期望结果应该包含 vbuf2, vbuf3, vbuf4"
echo "因为："
echo "- vbuf2的输入I连接到vbuf1的输出O"
echo "- vbuf3的输入I连接到vbuf2的输出O"  
echo "- vbuf4的输入I连接到vbuf3的输出O"